<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">
<h:head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta charset="UTF-8"/>
    <title>Лабораторная работа 3 - Проверка попадания точки</title>
    <h:outputStylesheet name="styles/reset.css"/>
    <h:outputStylesheet name="styles/main.css"/>
    <script type="text/javascript" src="#{request.contextPath}/scripts/main.js"></script>
    <style>
        body.main-page input[id*="rValue_input"],
        body.main-page input.ui-spinner-input,
        body.main-page input[id*="rValue"][id*="input"],
        body.main-page .ui-spinner input[type="text"] {
            text-align: left !important;
            direction: ltr !important;
            padding-left: 10px !important;
            padding-right: 40px !important;
            width: 150px !important;
            min-width: 150px !important;
            max-width: 150px !important;
            color: #000000 !important;
            background-color: #ffffff !important;
            overflow: visible !important;
            text-overflow: clip !important;
            white-space: nowrap !important;
            box-sizing: border-box !important;
            position: relative !important;
        }
        
        body.main-page .ui-spinner {
            display: inline-block !important;
            width: auto !important;
            vertical-align: middle !important;
        }
        
        body.main-page .ui-spinner .ui-spinner-input,
        body.main-page .ui-spinner input {
            width: 150px !important;
            min-width: 150px !important;
            max-width: 150px !important;
        }
        
        body.main-page .ui-spinner .ui-spinner-button {
            position: absolute !important;
            right: 0 !important;
        }
        
        body.main-page .r-spinner input,
        body.main-page .r-spinner .ui-spinner-input,
        body.main-page .r-spinner input[type="text"] {
            text-align: left !important;
            direction: ltr !important;
            padding-left: 10px !important;
            padding-right: 40px !important;
            width: 150px !important;
            min-width: 150px !important;
            max-width: 150px !important;
            color: #000000 !important;
            background-color: #ffffff !important;
            overflow: visible !important;
            text-overflow: clip !important;
            white-space: nowrap !important;
            box-sizing: border-box !important;
        }
    </style>
</h:head>
<body class="main-page">
    <h:form id="mainForm">
        <div class="form-section">
            <h2>Проверка попадания точки</h2>
            
            <div class="form-group">
                <h:outputLabel value="X:"/>
                <div class="button-group" id="xButtonGroup">
                    <button type="button" class="btn x-btn" data-x="-5" onclick="selectXValue(-5); return false;">-5</button>
                    <button type="button" class="btn x-btn" data-x="-4" onclick="selectXValue(-4); return false;">-4</button>
                    <button type="button" class="btn x-btn" data-x="-3" onclick="selectXValue(-3); return false;">-3</button>
                    <button type="button" class="btn x-btn" data-x="-2" onclick="selectXValue(-2); return false;">-2</button>
                    <button type="button" class="btn x-btn" data-x="-1" onclick="selectXValue(-1); return false;">-1</button>
                    <button type="button" class="btn x-btn" data-x="0" onclick="selectXValue(0); return false;">0</button>
                    <button type="button" class="btn x-btn" data-x="1" onclick="selectXValue(1); return false;">1</button>
                    <button type="button" class="btn x-btn" data-x="2" onclick="selectXValue(2); return false;">2</button>
                    <button type="button" class="btn x-btn" data-x="3" onclick="selectXValue(3); return false;">3</button>
                </div>
                <h:inputHidden id="xValue" value="#{areaCheckBean.x}" required="true" requiredMessage="X обязателен для ввода">
                    <f:convertNumber integerOnly="true"/>
                    <f:validator validatorId="xValidator"/>
                </h:inputHidden>
                <h:message for="xValue" styleClass="error-message" id="xValueMessage"/>
            </div>
            
            <div class="form-group">
                <h:outputLabel for="yValue" value="Y:"/>
                <h:inputText id="yValue" value="#{areaCheckBean.y}" 
                            required="true" requiredMessage="Y обязателен для ввода"
                            converter="jakarta.faces.Double"
                            oninput="validateYInput(this);">
                    <f:validateDoubleRange minimum="-3.0" maximum="3.0"
                                         minimumMessage="Y должен быть не менее -3.0"
                                         maximumMessage="Y должен быть не более 3.0"/>
                </h:inputText>
                <p class="hint-text">
                    Диапазон: от -3 до 3
                </p>
                <h:message for="yValue" styleClass="error-message" id="yValueMessage"/>
            </div>
            
            <div class="form-group">
                <h:outputLabel for="rValue" value="R:"/>
                <p:spinner id="rValue" value="#{areaCheckBean.r}" 
                          min="0.1" max="3.0" stepFactor="0.1" 
                          required="true" requiredMessage="R is required"
                          decimalPlaces="1"
                          style="direction: ltr !important;"
                          styleClass="r-spinner">
                    <f:validateDoubleRange minimum="0.1" maximum="3.0" 
                                         minimumMessage="R must be at least 0.1"
                                         maximumMessage="R must be at most 3.0"/>
                </p:spinner>
                <p class="hint-text">
                    Шаг изменения: 0.1
                </p>
                <h:message for="rValue" styleClass="error-message"/>
            </div>
            
            <div class="form-group">
                <h:outputLabel for="typeSelect" value="Тип:"/>
                <h:selectOneMenu id="typeSelect" value="#{areaCheckBean.type}" 
                                required="true" requiredMessage="Тип обязателен для выбора">
                    <f:selectItem itemValue="SPIDER" itemLabel="Паук"/>
                    <f:selectItem itemValue="ANT" itemLabel="Муравей"/>
                    <f:ajax event="change" render="spiderFields antFields" 
                            oncomplete="updateTypeFields();"/>
                </h:selectOneMenu>
                <h:message for="typeSelect" styleClass="error-message"/>
            </div>
            
            <h:panelGroup id="spiderFields">
                <div class="form-group" style="display: #{areaCheckBean.type == 'SPIDER' ? 'block' : 'none'};">
                    <h:outputLabel for="legsQuantity" value="Количество лапок (оставьте пустым для случайного):"/>
                    <h:inputText id="legsQuantity" value="#{areaCheckBean.legsQuantity}" 
                                converter="jakarta.faces.Integer">
                        <f:validateLongRange minimum="1" maximum="1000"
                                            minimumMessage="Количество лапок должно быть не менее 1"
                                            maximumMessage="Количество лапок должно быть не более 1000"/>
                    </h:inputText>
                    <h:message for="legsQuantity" styleClass="error-message"/>
                </div>
            </h:panelGroup>
            
            <h:panelGroup id="antFields">
                <div class="form-group" style="display: #{areaCheckBean.type == 'ANT' ? 'block' : 'none'};">
                    <h:outputLabel for="bodyColor" value="Body Color (leave empty for random):"/>
                    <h:inputText id="bodyColor" value="#{areaCheckBean.bodyColor}"/>
                    <h:message for="bodyColor" styleClass="error-message"/>
                </div>
            </h:panelGroup>
            
            <h:commandButton id="checkButton" value="Проверить" action="#{areaCheckBean.checkPoint()}">
                <f:ajax execute="@form" render="mainForm:resultsTable mainForm:yValueMessage mainForm:xValueMessage" 
                        oncomplete="setTimeout(function() { if (typeof drawAll === 'function') drawAll(); }, 100);"
                        onerror="console.error('Validation error occurred');"/>
            </h:commandButton>
        </div>
        
        <div class="form-section">
            <h2>Область</h2>
            <div class="canvas-container">
                <canvas id="area" width="400" height="400"></canvas>
            </div>
            <p class="canvas-hint">
                Перемещайте курсор по графику для выбора X и Y. Клик для отправки формы.
            </p>
        </div>
        
        <script type="text/javascript" src="#{request.contextPath}/scripts/area.js"></script>
        
        <div class="form-section">
            <h2>История проверок</h2>
            <h:panelGroup id="resultsTable">
            <h:dataTable value="#{resultsBean.results}" var="result" styleClass="results-table">
            <h:column>
                <f:facet name="header">Время выполнения</f:facet>
                <h:outputText value="#{result.executionTime}"/>
            </h:column>
            <h:column>
                <f:facet name="header">X</f:facet>
                <h:outputText value="#{result.x}"/>
            </h:column>
            <h:column>
                <f:facet name="header">Y</f:facet>
                <h:outputText value="#{result.y}"/>
            </h:column>
            <h:column>
                <f:facet name="header">R</f:facet>
                <h:outputText value="#{result.r}">
                    <f:convertNumber maxFractionDigits="1"/>
                </h:outputText>
            </h:column>
            <h:column>
                <f:facet name="header">Попадание</f:facet>
                <h:outputText value="#{result.hit ? 'Да' : 'Нет'}"/>
            </h:column>
            <h:column>
                <f:facet name="header">Тип</f:facet>
                <h:outputText value="#{result.type == 'SPIDER' ? 'Паук' : (result.type == 'ANT' ? 'Муравей' : 'Неизвестно')}"/>
            </h:column>
            <h:column rendered="#{result.type == 'SPIDER'}">
                <f:facet name="header">Legs Quantity</f:facet>
                <h:outputText value="#{result.legsQuantity}"/>
            </h:column>
            <h:column rendered="#{result.type == 'ANT'}">
                <f:facet name="header">Body Color</f:facet>
                <h:outputText value="#{result.bodyColor}"/>
            </h:column>
        </h:dataTable>
        </h:panelGroup>
        </div>
    </h:form>
    
    <h:link outcome="start" value="Вернуться на стартовую страницу" styleClass="link"/>
    
    <script>
     
        var currentR = #{areaCheckBean.r != null ? areaCheckBean.r : 1.0};
        var currentX = #{areaCheckBean.x != null ? areaCheckBean.x : 'null'};
        var currentY = #{areaCheckBean.y != null ? areaCheckBean.y : 'null'};
    </script>
    <script>
    <![CDATA[
        function validateYInput(input) {
            const value = parseFloat(input.value);
            const minY = -3.0;
            const maxY = 3.0;
            const messageElement = document.getElementById('mainForm:yValueMessage') || 
                                 document.querySelector('[id$=":yValueMessage"]');
            
            if (input.value.trim() === '') {
                if (messageElement) {
                    messageElement.textContent = '';
                    messageElement.style.display = 'none';
                }
                input.style.borderColor = '';
                return true;
            }
            
            if (isNaN(value)) {
                if (messageElement) {
                    messageElement.textContent = 'Y должен быть числом';
                    messageElement.style.display = 'block';
                }
                input.style.borderColor = '#b00020';
                return false;
            }
            
            var isLessThanMin = value < minY;
            var isGreaterThanMax = value > maxY;
            if (isLessThanMin || isGreaterThanMax) {
                if (messageElement) {
                    messageElement.textContent = 'Y должен быть в диапазоне от ' + minY + ' до ' + maxY;
                    messageElement.style.display = 'block';
                }
                input.style.borderColor = '#b00020';
                return false;
            }
            
            if (messageElement) {
                messageElement.textContent = '';
                messageElement.style.display = 'none';
            }
            input.style.borderColor = '';
            return true;
        }
        
        window.validateYInput = validateYInput;
        
        function updateTypeFields() {
            var typeSelect = document.getElementById('mainForm:typeSelect') || 
                           document.querySelector('[id$=":typeSelect"]');
            var spiderFields = document.getElementById('mainForm:spiderFields') || 
                              document.querySelector('[id$=":spiderFields"]');
            var antFields = document.getElementById('mainForm:antFields') || 
                           document.querySelector('[id$=":antFields"]');
            
            if (typeSelect && spiderFields && antFields) {
                var selectedType = typeSelect.value;
                if (selectedType === 'SPIDER') {
                    spiderFields.style.display = 'block';
                    antFields.style.display = 'none';
                } else if (selectedType === 'ANT') {
                    spiderFields.style.display = 'none';
                    antFields.style.display = 'block';
                }
            }
        }
        
        // Обновляем поля при изменении типа
        document.addEventListener('DOMContentLoaded', function() {
            var typeSelect = document.getElementById('mainForm:typeSelect') || 
                           document.querySelector('[id$=":typeSelect"]');
            if (typeSelect) {
                typeSelect.addEventListener('change', updateTypeFields);
                updateTypeFields(); // Инициализация при загрузке
            }
        });
    ]]>
    </script>
</body>
</html>

